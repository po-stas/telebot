# AllClimb Telegram Bot
Итоговый проект на курсе "NLP". 
Ссылка на бота: t.me/allclimb_bot

#### Краткие вводные
Задача сделать бота отвечающего на абстрактные вопросы не вызывала большого энтузиазма. Поэтому данная работа - попытка перевести задачу в некую практическую плоскость.. Есть сервис - путеводитель по скалолазным маршрутам AllClimb. Разрабатывается как личный некоммерческий хобби-проект. Сервис состоит из бэкенда хранящего информацию о 30К+ скалолазных маршрутах в России и за рубежом. Клиентская часть состоит из приложений под мобильные платформы, сайта (https://allclimb.com) и инструментария для распределенного администрирования базы.

###### Задача - сделать бота, который предоставляет некий разговорный интерфейс в базу маршрутов через мессенджеры.
Чтобы пользователь мог задать вопрос по интересующему маршруту непосредственно из Телеграм (или потенциально других мессенджеров). Практическая польза такого инструмента пока не очень понятна - имея мобильное приложение можно легко получить необходимую информацию, но раз можно - почему не попробовать..

#### Чат бот
Задача реализована в виде Телеграм чат-бота который находится по ссылке t.me/allclimb_bot. У бота можно узнавать подробности о маршрутах просто отправляя ему их названия. Либо задавать простые вопросы вида: Где находится маршрут имя_маршрута? или сколько веревки нужно на имя_маршрута? Сколько людей пролезло маршрут имя_маршрута? И так далее.. 

#### Дальнейшее развитие
Сейчас это некая первая альфа, и реализация далека от идеала. В будущем планируется двигаться в сторону контекстного общения. То-есть бот должен будет предлагать найти и выбрать требуемый маршрут (из нескольки ближайших вариантов) и оставаться в контексте выбранного маршрута, отвечая на вопросы без указания имени маршрута. И выходить из контекста при получении от пользователя запроса на поиск другого маршрута.. Также интересно направление развития бота из чисто справочной системы в некоего помошника в сервисе. Чтобы через него пользователь мог отмечать пройденные им маршруты, писать комментарии к маршрутам, ставить отметки нравится (это все реализовано в приложениях, но возможно работа из мессенджера будет тоже удобна кому-то)..

#### Реализация
Проект использует претренированный класс SQuAD от Deeppavlov.ai. Этот "агент", как они его называют, умеет анализировать небольшие тексты и выдавать ответы на поступающие вопросы, основываясь на информации из заданного текста. Сеть построена на архитектуре BERT и довольно интересно работает с небольшими объемами текста, может легко обрабатывать человеческие вопросы. Поначалу представлялась довольно несложным вариантом получить систему понимающую "человеко-подобную" речь. Чтобы не скатываться в ограничение пользователя определенной системой команд при общении с ботом.. На практике все выглядит не так радужно, прежде всего из-за ограниченности BERT архитектуры по длине обрабатываемой последовательности. В классическом Берте это 512 токенов. Для анализа огромной базы (из десятков тысяч текстовых записей) это явно не подходило. В результате исходная информация была представлена в виде списка текстов к отдельным маршрутам с поиском по заданному имени. Поиск осуществляется на основе векторного представления введенного пользователем названия из списка векторных представлений названий маршрутов нашей базы. Для векторизации используется другой Берт (от sberbank_nlp). Теоретически наверное правильнее было бы возложить эту задачу на тот-же SQuAD_rubert от Deeppavlov, но в условиях дефицита времени, разобраться, как достать эмбеддинги из их "агента", состоящего из десятка разных компонентов, пока не удалось. 

#### Техническая реализация
Проект построен так, чтобы работать в виде отдельного суб-сервиса внутри бэкенда AllClimb. Заводить его внутрь основного проекта не очень хотелось, поскольку deeppavlov требует довольно старой версии python и еще множество древних зависимостей. В результате, ключевой компонент (собственно сам SQuAD) работает внутри flask исполняющегося на том же сервере и доступном только изнутри системы по локальному адресу. Запросы от Telegram приходят в view основного (django) бэкэнда и оттуда вызывается flask app cо SQuAD-ом. Ответы отправляются в Телеграм. Кроме того база для ответов ежедневно регенерируется, и для нее пере-высчитываются эмбеддинги названий маршрутов.

#### Файловая структура
Конечно - это не рабочий проект в том виде, в котором он работает на сервисе. Эта структура папок - просто выжимка для сдачи курсовой работы. Итак, что находится в папках: 
- cron_tasks - модули занимающиеся ежедневной регенерацией справочной базы и эмбеддингов для поиска по ней.
- flask_app - ядро бота - приложение которое векторизует вопрос пользователя, ищет ближайшие вектора в списке сгенерированных векторов из базы и запускает SQuAD на соответствующес фрагменте текста. Результат отдает вызывающему в виде json.
- proof_of_concept - это папка с разработками. Здесь лежат ноутбуки в которых отлаживались все процессы. Первым тестом был вариант на TensorFlow (name_matcher.ipynb), но при попытке объединения его с Павловским SQuAD-ом выявилась непреодолимая преграда в виде древнего tf с которым ничего кроме Павлова не работает уже. В итоге все было переписано на Pytorch (он у Павлова более менее свежий). И Берт для генерации эмбеддингов и матчинга имен работает на Торче. (файл qa_test.ipynb)
- webhook_view - папка содержащая вью работающее в джанго бэкенде. Это то, что принимает запросы от телеграм, вызывает flask-SQuAD, и отправляет результаты обратно в Телеграм.

#### Итоги
Несмотря на то, что бот запущен и работает (можно ознакомиться с ним подключившись по ссылке t.me/allclimb_bot), работа еще далеко не закончена. Названия маршрутов - это не всегда валидные слова из языка (иногда авторы креативят в сторону неких каламбуров или вообще неосмысленных буквосочетаний). В этой ситуации использование претрейненного Берта для векторизации названий - возможно не очень оправдана - он натренирован на слова - на настоящие слова. Возможно можно попробовать отказаться от встроенной токенизации - и разбивать все самому - на буквы. Вобшем, возможно в процессе дальнейшего развития архитектурные и технические решения будут серъезно пересмотрены. 


 
